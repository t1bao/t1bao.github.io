"use strict";function onBackKeyDown(a){console.log("onbackkey"),a.preventDefault()}document.addEventListener("deviceready",function(){console.log("deviceready")},!1),document.addEventListener("backbutton",onBackKeyDown,!1),angular.module("mmbaoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngMaterial","ngMessages"]).config(["$routeProvider","$httpProvider","$sceProvider",function(a,b,c){b.defaults.useXDomain=!0,b.defaults.withCredentials=!0,window.errors=webErrors.errors,c.enabled(!1),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/user/home",{templateUrl:"views/user/home.html",controller:"UserCtrl"}).when("/user/login",{templateUrl:"views/user/login.html",controller:"UserCtrl"}).when("/user/register",{templateUrl:"views/user/register.html",controller:"UserCtrl"}).when("/store/profile",{templateUrl:"views/store/profile.html",controller:"StoreCtrl"}).when("/merchandise/list",{templateUrl:"views/merchandise/list.html",controller:"MerchandiseCtrl"}).when("/merchandise/add",{templateUrl:"views/merchandise/add.html",controller:"MerchandiseCtrl"}).when("/barcode/list",{templateUrl:"views/barcode/list.html",controller:"BarcodeCtrl"}).when("/barcode/bind/:id",{templateUrl:"views/barcode/bind.html",controller:"BarcodeCtrl"}).when("/scan/barcode",{templateUrl:"views/scan/barcode.html",controller:"ScanCtrl"}).when("/scan/add/:id",{templateUrl:"views/scan/add.html",controller:"ScanCtrl"}).when("/merchandise/info",{templateUrl:"views/merchandise/info.html",controller:"MerchandiseCtrl"}).when("/barcode/info",{templateUrl:"views/barcode/info.html",controller:"BarcodeCtrl"}).when("/user/profile",{templateUrl:"views/user/profile.html",controller:"UserCtrl"})}]),angular.module("mmbaoApp").controller("MainCtrl",["$scope","$location","$mdSidenav","messages","dialog",function(a,b,c,d,e){var f=!1;a.login=function(){if(!f){f=!0;var a=new FormData($("form")[0]);d.user.login(a,function(){f=!1,e.toast("登录成功！"),b.path("user/home")})}},a.toggleSidenav=function(a){c(a).toggle()},a.toRegister=function(){b.path("user/register")}}]),angular.module("mmbaoApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("mmbaoApp").service("api",["$http","$location","url","dialog","fallback","prefix",function(a,b,c,d,e,f){function g(a){return c+f+a}function h(c,f,h,j){if(!i){i=!0;var k;k=f?f instanceof FormData?a.post(g(c),f,{withCredentials:!0,headers:{"Content-Type":void 0},transformRequest:angular.identity}):a.post(g(c),f):a.post(g(c)),j=j||e,k.success(function(a){if(i=!1,"code"in a)if("code"in a&&!a.code)h(a);else switch(a.code){case errors.USER_NOT_LOGIN.code:b.path(j);break;case errors.DATABASE_ERROR.code:case errors.INPUT_INVALID.code:d.alert(a.message);break;default:d.alert(a.message),b.path(j)}else;}).error(function(){i=!1,"user/profile"===c&&b.path(j)})}}var i=!1;return{send:function(a,b,c,d){h(a,b,c,d)},auth:function(){h("user/profile",null,function(a){a&&"code"in a&&b.path(a.code?"/user/home":"/user/login")})},logout:function(a){h("user/logout",null,function(b){a(b)})},list:function(a,b,c){h(a,b,function(a){c(a)})},upload:function(c,f,h){a.post(g(c),f,{withCredentials:!0,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(a){if("code"in a)if("code"in a&&!a.code)h(a);else switch(a.code){case errors.USER_NOT_LOGIN.code:b.path(e);break;default:d.alert(a.message)}else;}).error(function(){b.path(e)})},success:function(a,b,c,d){h(a,b,function(a){return d?c(a):void(a.code===errors.SUCCESS.code&&c(a))})}}}]),angular.module("mmbaoApp").service("dialog",["$mdDialog","$mdToast",function(a,b){return{alert:function(b,c){a.show(a.alert().title(c||"").content(b).ok("确定"))},confirm:function(b,c){a.show(a.confirm().title(c).content(b).ok("确定").cancel("取消"))},toast:function(a,c,d){var e=b.simple().content(a).position("top left right").hideDelay(3e3);c&&e.action(c),d instanceof Function?b.show(e).then(d):b.show(e)}}}]);var url="http://api.t1bao.com/";window.localStorage&&window.localStorage.getItem("url")&&(url=window.localStorage.getItem("url")),angular.module("mmbaoApp").constant("url",url).constant("fallback","user/login").constant("prefix","grocery/"),angular.module("mmbaoApp").directive("mdTable",function(){return{restrict:"E",scope:{headers:"=",content:"=",sortable:"=",filters:"=",customClass:"=customClass",thumbs:"=",count:"="},controller:["$scope","$filter",function(a,b){var c=b("orderBy");a.tablePage=0,a.nbOfPages=function(){return Math.ceil(a.content.length/a.count)},a.handleSort=function(b){return a.sortable.indexOf(b)>-1?!0:!1},a.order=function(b,d){a.content=c(a.content,b,d),a.predicate=b},a.order(a.sortable[0],!1),a.getNumber=function(a){return new Array(a)},a.goToPage=function(b){a.tablePage=b}}],template:angular.element(document.querySelector("#md-table-template")).html()}}),angular.module("mmbaoApp").controller("UserCtrl",["$scope","$route","$location","$mdDialog","messages","hardware","api","dialog","storage","barcode","lbs","user","images",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a,b){return a?(i.set("barcode",b),void c.path("/scan/barcode")):void h.toast("Not Found!")}switch(a.isEditing=!1,b.current.$$route.originalPath){case"/user/register":case"/user/login":case"/user/logout":break;case"/user/profile":l.profile(function(b){console.log("profile"),$(".progress-bar").hide(),a.user=b}),a.edit=function(){a.isEditing=!0,$("input[disabled]").removeAttr("disabled"),$("textarea[disabled]").removeAttr("disabled")},a.update=function(){var b=new FormData($("form")[0]);l.update(b,function(){a.isEditing=!1,h.toast("更新成功！"),setTimeout(function(){c.path("user/home")},1e3)})},a.fileChanged=function(){a.images=[],m.preview($("input[type=file][name=image]")[0].files,function(b){console.log(b),a.images.push(b),a.$apply()})};break;default:l.profile(function(b){console.log("profile"),$(".progress-bar").hide(),a.user=b}),a.items=[{icon:"fa-home",name:"门店信息",action:"profile()"},{icon:"fa-file",name:"订单",action:"orders()"},{icon:"fa-archive",name:"在售货品",action:"online()"},{icon:"fa-home",name:"添加商品",action:"createMerchandise()"}]}a.login=function(){var a=new FormData($("form")[0]);l.login(a)},a.logout=function(){l.logout()},a.register=function(){var a=new FormData($("form")[0]);console.log(a),l.register(a)},a.toRegister=function(){c.path("user/register")},a.toLogin=function(){c.path("user/login")},a.scan=function(){f.scanner.open(function(a,b,c){return a?(h.toast("扫描成功！"+b+","+c),void j.query(b,c,n)):void h.toast("扫描失败！")})},a.addMerchandise=function(){c.path("merchandise/add")},a.goBarcode=function(){c.path("barcode/list")},a.profile=function(){c.path("store/profile")},a.goMerchandise=function(){c.path("merchandise/list")},a.goPosition=function(){console.log("go position"),k.getPos(function(a){h.alert(a?"成功更新店铺位置！":"更新店铺位置失败！")})},a.myProfile=function(){console.log("go profile"),c.path("user/profile")},a.storeInfo=function(){c.path("store/profile")},a.back=function(){c.path("user/home")}}]),angular.module("mmbaoApp").controller("StoreCtrl",["$scope","$location","api","dialog","store",function(a,b,c,d,e){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.isEditing=!1,e.profile(function(b){a.store=b.data,$(".progress-bar").hide()}),a.back=function(){b.path("user/home")},a.edit=function(){a.isEditing=!0,$("input[disabled]").removeAttr("disabled"),$("textarea[disabled]").removeAttr("disabled")},a.update=function(){var c=new FormData($("form")[0]);e.update(c,function(){a.isEditing=!1,d.toast("更新成功！"),setTimeout(function(){b.path("user/home")},1e3)})}}]),angular.module("mmbaoApp").controller("MerchandiseCtrl",["$scope","$location","$route","api","dialog","merchandise","$timeout","images","hardware","storage","barcode",function(a,b,c,d,e,f,g,h,i,j,k){var l=c.current.$$route.originalPath;switch(l){case"/merchandise/add":var m=new FormData($("form")[0]);f.add(m,function(a){a.code&&(e.toast("添加成功!"),g(function(){b.path("user/home")},1e3))});break;case"/merchandise/list":var n=f.getList($(".progress-bar"),function(b,c){a.merchandises=b.results,a.total=b.total,a.page=b.page,a.lastPage=c});n.list(),a.next=function(){n.next()},a.prev=function(){n.prev()},a.headers=[{name:"商品图片"},{name:"商品名"},{name:"操作"}],a.remove=function(a){confirm("确定要删除吗?操作不可恢复!")&&a.remove(a.merchandise.id,function(){n.list()})},a.clickItem=function(a){j.set("merchandise",a),b.path("/merchandise/info")};break;case"/merchandise/info":$(".button").hide(),f.query(a,$(".progress-bar"),function(){}),a.edit=function(){$(".edit").hide(),$("input").attr("disabled",!1),$("textarea").attr("disabled",!1),$(".update").removeAttr("hidden")},a.update=function(){var a=new FormData($("form")[0]);f.update($(".progress-bar"),a,function(a){a&&(e.toast("更新成功!"),b.path("user/home"))})}}a.toAdd=function(){b.path("/merchandise/add")},a.back=function(){b.path("user/home")},a.save=function(){var a=new FormData($("form")[0]);d.success("merchandise/add",a,function(){e.toast("添加成功!"),setTimeout(function(){b.path("scan/barcode")},1e3)})},a.startCapture=function(){console.log("camera"),i.camera.start(function(a,b){$("input[type=file][name=image]").attr("src",b)})},a.fileChanged=function(){a.images=[],h.preview($("input[type=file][name=image]")[0].files,function(b){console.log(b),a.images.push(b),a.$apply()})},a.bind=function(a){var c=j.get("barcode");k.bind(c.id,a.id,function(){console.log(a),b.path("/barcode/list")})}}]),angular.module("mmbaoApp").controller("BarcodeCtrl",["$scope","$location","$route","$mdDialog","api","dialog","storage","merchandise","barcode",function(a,b,c,d,e,f,g,h,i){var j,k=c.current.$$route.originalPath;switch(k){case"/barcode/bind/:id":a.headers=[{name:"图片"},{name:"商品名"},{name:"操作"}],j=h.getList($(".progress-bar"),function(b,c){b.results.length&&(a.merchandises=b.results,a.total=b.total,a.page=b.page),a.lastPage=c}),j.list(),a.next=function(){j.next()},a.prev=function(){j.prev()},a.bind=function(a){var c=g.get("barcode");i.bind(c.id,a.id,function(){b.path("barcode/list")})},a.back=function(){b.path("barcode/list")};break;case"/barcode/info":a.barcode=g.get("barcode_info");var l=!1;$(".progress-bar").show(),l=!0,i.query(a.barcode.code,a.barcode.format,function(){l=!1,$(".progress-bar").hide()}),a.back=function(){b.path("barcode/list")},a.update=function(){var a=new FormData($("form")[0]);i.update($(".progress-bar"),a,function(a){a.code&&(f.toast("更新成功!"),b.path("user/home"))})};break;default:a.headers=[{name:"商品图片"},{name:"格式"},{name:"条码值"},{name:"商品名"},{name:"操作"}],j=i.getList($(".progress-bar"),function(b,c){b.results.length&&(a.barcodes=b.results,a.total=b.total,a.page=b.page),a.lastPage=c}),j.list(),a.next=function(){j.next()},a.prev=function(){j.prev()},a.remove=function(a){confirm("确定要删除吗?操作不可恢复!")&&a.remove(a.id,function(){$("barcode-remove-"+a.id).remove()})},a.unbind=function(a){confirm("确定解决商品绑定吗？操作不可恢复")&&i.unbind(a.barcode.id,function(){j.list()})},a.openBind=function(a){g.set("barcode",a),b.path("barcode/bind/"+a.id)},a.clickItem=function(a){g.set("barcode_info",a.barcode),b.path("/barcode/info")},a.back=function(){b.path("user/home")}}}]),angular.module("mmbaoApp").service("admin",function(){}),angular.module("mmbaoApp").service("messages",["api",function(a){return{merchandise:{add:function(b,c){a.success("merchandise/add",b,c)},removeImage:function(b,c){a.success("merchandise/image/remove",{id:b},c)},list:function(b,c){a.success("merchandise/list",{page:b},c)},update:function(b,c){a.success("merchandise/update",b,c)},remove:function(b,c){a.success("merchandise/remove",{id:b},c)},info:function(b,c){a.success("merchandise/info",{id:b},c)}},barcode:{query:function(b,c,d){a.send("barcode/query",{code:b,format:c},d)},list:function(b,c){a.success("barcode/list",{page:b},c)},bind:function(b,c,d){a.success("barcode/bind",{barcode:b,merchandise:c},d)},remove:function(b,c){a.success("barcode/remove",{id:b},c)},unbind:function(b,c){a.success("barcode/unbind",{barcode:b},c)}},user:{login:function(b,c){a.success("user/login",b,c)},logout:function(b){a.success("user/logout",{},b)},profile:function(b){a.success("user/profile",{},b)},register:function(b,c){a.success("user/register",b,c)},update:function(b,c){a.success("user/update",b,c)}},store:{profile:function(b){a.success("store/profile",{},b)},update:function(b,c){a.success("store/update",b,c)}},location:{update:function(b,c){a.success("location/update",b,c)}}}}]),angular.module("mmbaoApp").service("storage",function(){var a={};return{set:function(b,c){a[b]=c,window.localStorage&&window.localStorage.setItem(b,JSON.stringify(c))},get:function(b){if(a[b])return a[b];if(window.localStorage){var c=window.localStorage.getItem(b);return c=JSON.parse(c)}}}}),angular.module("mmbaoApp").controller("ScanCtrl",["$scope","$location","$timeout","dialog","storage","barcode","api","hardware","images","merchandise",function(a,b,c,d,e,f,g,h,i,j){a.barcode=e.get("barcode"),a.back=function(){b.path("user/home")};var k=j.getList($(".progress-bar"),function(b,c){a.merchandises=b.results,a.total=b.total,a.page=b.page,a.lastPage=c});k.list(),a.next=function(){k.next()},a.prev=function(){k.prev()},a.add=function(){b.path("/scan/add/"+a.barcode.id)},a.backBarcode=function(){b.path("/scan/barcode")},a.save=function(){var a=new FormData($("form")[0]);g.success("merchandise/add",a,function(){d.toast("添加成功!"),setTimeout(function(){b.path("scan/barcode")},1e3)})},a.startCapture=function(){console.log("camera"),h.camera.start(function(a,b){$("input[type=file][name=image]").attr("src",b)})},a.fileChanged=function(){a.images=[],i.preview($("input[type=file][name=image]")[0].files,function(b){console.log(b),a.images.push(b),a.$apply()})},a.bind=function(a){var c=e.get("barcode");f.bind(c.id,a.id,function(){console.log(a),b.path("/barcode/list")})}}]),angular.module("mmbaoApp").service("hardware",["dialog",function(a){return{camera:{start:function(b){if(!navigator.camera)return void a.alert("no camera found!");var c={quality:50,destinationType:window.Camera.DestinationType.FILE_URI,sourceType:1,encodingType:0};navigator.camera.getPicture(function(a){b(!0,a)},function(){console.log("failed to capture images"),b(!1)},c)}},scanner:{open:function(a){if(window.cordova)window.cordova.plugins.barcodeScanner.scan(function(b){null===b.text||void 0===b.text||""===b.text?a(!1):a(!0,b.text,b.format)});else{var b="4719579945280";b="4719579945280";var c="EAN_13";a(!0,b,c)}}}}}]),angular.module("mmbaoApp").service("images",function(){return{preview:function(a,b){function c(a){var c=new FileReader;c.readAsDataURL(a),c.onload=function(a){b(a.target.result)}}if(a)for(var d=0;d<a.length;d++)c(a[d])}}}),angular.module("mmbaoApp").service("user",["messages","$location","dialog",function(a,b,c){var d=a.user,e=null;return{profile:function(a){return e?void a(e):void d.profile(function(b){e=b.data,a(e)})},login:function(d){a.user.login(d,function(){c.toast("登录成功！"),b.path("user/home")})},logout:function(){a.user.logout(function(){b.path("user/login")})},register:function(d){a.user.logout(d,function(){c.toast("注册成功！"),b.path("user/home")})},update:function(d){a.user.update(d,function(){c.toast("更新成功！"),e=null,b.path("user/home")})}}}]),angular.module("mmbaoApp").service("merchandise",["messages","storage",function(a,b){return{getList:function(b,c){var d=1,e=!1,f=!1;return{list:function(g){d=g||d,f||(b.show(),f=!0,a.merchandise.list(d,function(a){f=!1,b.hide(),c(a.data,e)}))},prev:function(){d>1&&(d--,this.list(d))},next:function(){d++,this.list(d)}}},add:function(b,c){a.merchandise.add(b,c)},remove:function(b,c){a.merchandise.remove(b,c)},query:function(c,d,e){var f=!1;d.show(),f=!0,f=!1,c.merchandise=b.get("merchandise"),f=!1,d.hide(),a.merchandise.info(e)},update:function(b,c,d){var e=!1;b.show(),e=!0,a.merchandise.update(c,function(){e=!1,b.hide()}),a.merchandise.update(c,d)}}}]),angular.module("mmbaoApp").service("barcode",["messages",function(a){return{getList:function(b,c){var d=1,e=!1,f=!1;return{list:function(g){d=g||d,f||(b.show(),f=!0,a.barcode.list(d,function(a){f=!1,b.hide(),c(a.data,e)}))},prev:function(){d>1&&(d--,this.list(d))},next:function(){d++,this.list(d)}}},add:function(b,c){a.barcode.add(b,c)},remove:function(b,c){a.barcode.remove(b,c)},bind:function(b,c,d){a.barcode.bind(b,c,d)},unbind:function(b,c){a.barcode.unbind(b,c)},query:function(b,c,d){a.barcode.query(b,c,function(a){switch(a.code){case errors.NOT_FOUND.code:d(!1,a.data);break;case errors.SUCCESS.code:d(!0,a.data)}})}}}]),angular.module("mmbaoApp").service("store",["messages",function(a){return{profile:a.store.profile,update:a.store.update}}]),angular.module("mmbaoApp").service("lbs",["messages",function(a){return{getPos:function(b){if(navigator.geolocation){var c=function(c){a.location.update(c.coords,function(a,c){b(!0,c)})},d=function(a){b(!1,a)};navigator.geolocation.getCurrentPosition(c,d)}else console.log("not supported")}}}]);