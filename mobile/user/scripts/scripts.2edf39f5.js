"use strict";function onBackKeyDown(a){console.log("onbackkey"),a.preventDefault()}document.addEventListener("deviceready",function(){console.log("deviceready")},!1),document.addEventListener("backbutton",onBackKeyDown,!1),angular.module("mmbaoApp",["ngRoute"]).config(["$routeProvider","$httpProvider","$sceProvider",function(a,b,c){b.defaults.useXDomain=!0,b.defaults.withCredentials=!0,window.errors=webErrors.errors,c.enabled(!1),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/user/home",{templateUrl:"views/user/home.html",controller:"UserCtrl"}).when("/user/login",{templateUrl:"views/user/login.html",controller:"UserCtrl"}).when("/user/register",{templateUrl:"views/user/register.html",controller:"UserCtrl"}).when("/user/phone/register",{templateUrl:"views/phone/input.html",controller:"UserCtrl"}).when("/user/email/register",{templateUrl:"views/email/input.html",controller:"UserCtrl"}).when("/user/password/retrieve",{templateUrl:"views/password/retrieve.html",controller:"UserCtrl"}).when("/grocery",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/list",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/recent",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/favorite",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/list/:page",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/nearby",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/nearby/:page",{templateUrl:"views/grocery/list.html",controller:"GroceryCtrl"}).when("/grocery/info/:id",{templateUrl:"views/grocery/info.html",controller:"GroceryCtrl"}).when("/grocery/profile/:id",{templateUrl:"views/grocery/profile.html",controller:"GroceryCtrl"}).when("/grocery/comments/:id",{templateUrl:"views/grocery/comments.html",controller:"GroceryCtrl"}).when("/order/list",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/list/:page",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/make/:id",{templateUrl:"views/order/make.html",controller:"OrderCtrl"}).when("/order/pay/:id",{templateUrl:"views/pay/select.html",controller:"PayCtrl"}).when("/pay/alipay/:id",{templateUrl:"views/pay/alipay.html",controller:"PayCtrl"}).when("/order/success/:id",{templateUrl:"views/order/sucess.html",controller:"OrderCtrl"}).when("/order/failed/:id",{templateUrl:"views/order/failed.html",controller:"OrderCtrl"}).when("/user/settings",{templateUrl:"views/user/settings.html",controller:"UserCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"SystemCtrl"}).when("/user/feedback",{templateUrl:"views/user/feedback.html",controller:"UserCtrl"}).when("/user/profile",{templateUrl:"views/user/profile.html",controller:"UserCtrl"}).when("/user/subscribe",{templateUrl:"views/user/subscribe.html",controller:"UserCtrl"}).when("/user/subscribe/:page",{templateUrl:"views/user/subscribe.html",controller:"UserCtrl"}).when("/address/list",{templateUrl:"views/address/list.html",controller:"AddressCtrl"}).when("/address/list/:page",{templateUrl:"views/address/list.html",controller:"AddressCtrl"}).when("/address/add",{templateUrl:"views/address/add.html",controller:"AddressCtrl"}).when("/address/edit/:id",{templateUrl:"views/address/edit.html",controller:"AddressCtrl"}).when("/cart",{templateUrl:"views/cart/list.html",controller:"CartCtrl"})}]);var app=angular.module("mmbaoApp");app.run(["$rootScope",function(a){a.$on("$routeChangeStart",function(){if(console.log("on change start"),console.log(arguments),localStorage)switch(location.hash){case"#/user/phone/register":case"#/user/email/register":case"#/user/register":case"#/user/login":break;default:localStorage.setItem("referrer",location.hash.substring(2))}})}]),angular.module("mmbaoApp").service("register",["modal","messages","$location","user",function(a,b,c,d){return{username:function(){var b=new FormData($("form")[0]),e=$("input[name=username]").val(),f=$("input[name=password]").val(),g=$("input[name=confirm]").val(),h=$("input[name=phone]").val(),i=$("input[name=email]").val();return e?f?f!==g?void a.alert("密码不一致!"):h&&validator&&!validator.isMobilePhone(h,"zh-CN")?void a.alert("手机号不正确!"):i&&validator&&!validator.isEmail(i)?void a.alert("邮箱不正确!"):(a.startProgress("正在注册用户..."),void d.register(b,function(b){a.stopProgress(function(){b.code===errors.SUCCESS.code?a.alert("注册成功！",function(){c.path("user/login")}):a.alert(b.message)})})):void a.alert("请输入密码!"):void a.alert("请输入用户名!")},phone:function(d){return d.phone?validator.isMobilePhone(d.phone,"zh-CN")?d.captchaString?d.password?d.password.length<=6?void a.alert("请输入6位或以上长度的密码!",function(){}):d.password.length>32?void a.alert("请输入32位或以下长度的密码!",function(){}):($(".btn-register").attr("disabled","disabled"),void b.captcha.register({phone:d.phone,captcha:d.captchaString,password:d.password},function(b){switch(b.code){case errors.SUCCESS.code:a.alert("注册成功！",function(){c.path("user/login")});break;default:a.alert(b.message),setTimeout(function(){$(".btn-register").removeAttr("disabled")},5e3)}})):void a.alert("请输入密码!",function(){}):void a.alert("请输入验证码!",function(){}):void a.alert("手机号不正确!",function(){}):void a.alert("请输入手机号！",function(){})},email:function(d){return d.email?validator.isEmail(d.email)?d.captchaString?d.password?d.password.length<=6?void a.alert("请输入6位或以上长度的密码!",function(){}):d.password.length>32?void a.alert("请输入32位或以下长度的密码!",function(){}):($(".btn-register").attr("disabled","disabled"),void b.captcha.register({email:d.email,captcha:d.captchaString,password:d.password},function(b){switch(console.log(b),b.code){case errors.SUCCESS.code:a.alert("注册成功！",function(){c.path("user/login")});break;default:a.alert(b.message),setTimeout(function(){$(".btn-register").removeAttr("disabled")},1e3)}})):void a.alert("请输入密码!",function(){}):void a.alert("请输入验证码!",function(){}):void a.alert("电子邮箱格式不正确!",function(){}):void a.alert("请输入电子邮箱！",function(){})}}}]),angular.module("mmbaoApp").service("api",["$http","$rootScope","$location","url","modal","fallback","prefix",function(a,b,c,d,e,f,g){function h(a){return d+g+a}function i(d,g,i,k,l){j=!0;var m;m=g?g instanceof FormData?a.post(h(d),g,{withCredentials:!0,headers:{"Content-Type":void 0},transformRequest:angular.identity}):a.post(h(d),g):a.post(h(d)),k=k||f,m.success(function(a){if(j=!1,"object"!=typeof a)i(a);else if("code"in a&&!a.code)i(a);else if(l)l(a);else switch(a.code){case errors.DATABASE_ERROR.code:case errors.INPUT_INVALID.code:case errors.EXISTED.code:case errors.NOT_FOUND.code:e.alert(a.message,function(){e.stopProgress()});break;default:e.alert(a.message,function(){console.log("inside ok 1"),console.log(k),e.stopProgress(),b.$apply(function(){c.path(k)})})}}).error(function(){j=!1,"user/profile"===d&&c.path(k)})}var j=!1;return{send:function(a,b,c,d,e){i(a,b,c,d,e)},auth:function(){i("user/profile",null,function(a){a&&"code"in a&&(a.code?c.path("/user/home"):c.path("/user/login"))})},logout:function(a){i("user/logout",null,function(b){a(b)})},list:function(a,b,c){i(a,b,function(a){c(a)})},upload:function(b,d,g){a.post(h(b),d,{withCredentials:!0,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(a){if("code"in a)if("code"in a&&!a.code)g(a);else switch(a.code){case errors.USER_NOT_LOGIN.code:c.path(f);break;default:e.alert(a.message)}else;}).error(function(){c.path(f)})},success:function(a,b,d,e){i(a,b,function(a){if(e)return d(a);switch(a.code===errors.SUCCESS.code&&d(a),a.code){case errors.USER_NOT_LOGIN.code:case errors.NOT_LOGIN.code:c.path(f)}})},selfSend:function(a,b,c){i(a,b,function(a){a.code===errors.SUCCESS.code&&c(a)},null,c)},text:function(a,b,c){i(a,b,function(a){c(a)})}}}]),angular.module("mmbaoApp").service("dialog",function(){return{alert:function(){},confirm:function(){},toast:function(){}}});var url="http://api.t1bao.com/";window.localStorage&&window.localStorage.getItem("url")&&(url=window.localStorage.getItem("url")),angular.module("mmbaoApp").constant("url",url).constant("fallback","user/login").constant("prefix","customer/"),angular.module("mmbaoApp").service("messages",["api",function(a){return{user:{login:function(b,c){a.success("user/login",b,c)},logout:function(b){a.success("user/logout",{},b)},profile:function(b,c){c?a.selfSend("user/profile",{},b):a.success("user/profile",{},b)},register:function(b,c){a.selfSend("user/register",b,c)},update:function(b,c){a.success("user/update",b,c)},feedback:function(b,c){a.success("user/feedback",b,c)},subscribed:function(b,c){a.success("user/subscribed",b,c)}},location:{update:function(b,c){a.success("location/update",b,c)}},grocery:{list:function(b,c){a.success("store/list",b,c)},nearby:function(b,c){a.success("store/nearby",b,c)},search:function(b,c){a.success("store/search",b,c)},info:function(b,c){a.success("store/info",b,c)},subscribe:function(b,c){a.success("store/subscribe",b,c)},unsubscribe:function(b,c){a.success("store/unsubscribe",b,c)},issubscribed:function(b,c){a.selfSend("store/issubscribed",b,c)}},merchandise:{list:function(b,c){a.success("merchandise/list",b,c)},info:function(b,c){a.success("merchandise/info",b,c)}},order:{create:function(b,c){a.success("order/create",b,c)},list:function(b,c){a.success("order/list",b,c)}},pay:{alipay:function(b,c){a.text("pay/alipay",b,c)}},address:{add:function(b,c){a.success("address/add",b,c)},list:function(b,c){a.success("address/list",b,c)},update:function(b,c){a.success("address/update",b,c)},remove:function(b,c){a.success("address/remove",b,c)}},category:{list:function(b,c){a.success("category/list",b,c)},merchandise:function(b,c){a.success("category/merchandise/list",b,c)}},captcha:{check:function(b,c){a.selfSend("captcha/check",b,c)},phone:function(b,c){a.selfSend("captcha/phone",b,c)},email:function(b,c){a.selfSend("captcha/email",b,c)},register:function(b,c){a.selfSend("captcha/register",b,c)}},password:{retrieve:function(b,c){a.selfSend("password/retrieve",b,c)}}}}]),angular.module("mmbaoApp").service("storage",function(){var a={};return{set:function(b,c){a[b]=c,window.localStorage&&window.localStorage.setItem(b,JSON.stringify(c))},get:function(b){if(a[b])return a[b];if(window.localStorage){var c=window.localStorage.getItem(b);return c=JSON.parse(c)}}}}),angular.module("mmbaoApp").service("images",function(){return{preview:function(a,b){function c(a){var c=new FileReader;c.readAsDataURL(a),c.onload=function(a){b(a.target.result)}}if(a)for(var d=0;d<a.length;d++)c(a[d])}}}),angular.module("mmbaoApp").service("user",["messages","$location","modal",function(a,b,c){var d=a.user,e=null,f=!1;return{isLogin:function(){return f},profile:function(a,b){return e?void a(e):void d.profile(function(b){switch(e=b.data,console.log(b),b.code){case errors.SUCCESS.code:f=!0;break;default:f=!1}a(e)},b)},login:function(b,c){a.user.login(b,function(){f=!0,c()})},logout:function(){a.user.logout(function(){f=!1,b.path("user/login")})},register:function(b,c){a.user.register(b,c)},update:function(d){a.user.update(d,function(){c.alert("更新成功！",function(){e=null,b.path("user/home")})})},feedback:function(b,c){a.user.feedback(b,c)},subscribed:function(b,c){a.user.subscribed(b,c)}}}]),angular.module("mmbaoApp").service("merchandise",["messages",function(a){return{list:function(b,c,d){a.merchandise.list({id:b,page:c},d)}}}]),angular.module("mmbaoApp").service("store",["messages",function(a){return{profile:a.store.profile,update:a.store.update}}]),angular.module("mmbaoApp").service("lbs",["storage",function(a){return{getPos:function(b){if(navigator.geolocation){var c={enableHighAccuracy:!0,timeout:5e3,maximumAge:0},d=function(c){console.log(c);var d={latitude:c.coords.latitude,longitude:c.coords.longitude};console.log(d),a.set("pos",d),b(!0,c.coords)},e=function(a){b(!1,a)};navigator.geolocation.getCurrentPosition(d,e,c)}else console.log("not supported"),b(!1)}}}]),angular.module("mmbaoApp").service("grocery",["messages",function(a){var b=a.grocery,c=null;return{subscribe:function(a,c){b.subscribe({id:a},c)},unsubscribe:function(a,c){b.unsubscribe({id:a},c)},list:function(a,d){b.list({page:a},function(a){c=a.data.results,d(a.data)})},search:function(a,d,e){b.search({page:d,q:a},function(a){c=a.data.results,e(a.data)})},nearby:function(a,d,e){b.nearby({latitude:a.latitude,longitude:a.longitude,page:d},function(a){c=a.data.results,e(a.data)})},getItem:function(a){if(!c)return null;for(var b=0;b<c.length;b++){var d=c[b];if(d&&d.id===a)return d}return null},info:b.info}}]),angular.module("mmbaoApp").service("modal",["$timeout",function(a){return{alert:function(b,c){$("#modal-alert").modal("show"),$(".modal-body",$("#modal-alert")).html(b),$(".ok",$("#modal-alert")).unbind(),$(".ok",$("#modal-alert")).click(function(){$("#modal-alert").modal("hide"),$("#modal-progress").modal("hide"),a(function(){c&&c()},300)})},confirm:function(b,c,d){$("#modal-confirm").modal("show"),$(".modal-body",$("#modal-confirm")).html(b),$(".ok",$("#modal-confirm")).unbind(),$(".cancel",$("#modal-confirm")).unbind(),$(".ok",$("#modal-confirm")).click(function(){$("#modal-confirm").modal("hide"),a(function(){c&&c()},300)}),$(".cancel",$("#modal-confirm")).click(function(){$("#modal-confirm").modal("hide"),$("#modal-progress").modal("hide"),a(function(){d&&d()},300)})},startProgress:function(a){console.log(a),$("#modal-progress").modal("show"),$(".note",$("#modal-progress")).html(a)},stopProgress:function(b){$("#modal-progress").modal("hide"),b&&a(b,300)}}}]),angular.module("mmbaoApp").service("address",["messages",function(a){return{add:a.address.add,list:a.address.list,update:a.address.update,remove:a.address.remove}}]),angular.module("mmbaoApp").service("weixin",function(){return{config:function(){}}}),angular.module("mmbaoApp").filter("currency",function(){return function(a){return a=parseFloat(a).toFixed(2),isNaN(a)&&(a=0),parseFloat(a).toFixed(2)}}),angular.module("mmbaoApp").filter("distance",["storage",function(a){return function(b){function c(a){return a*(Math.PI/180)}function d(a,b){var d=6371;console.log(a),console.log(b);var e=c(a.latitude-b.latitude),f=c(a.longitude-b.longitude);console.log(e),console.log(f);var g=Math.sin(e/2)*Math.sin(e/2)+Math.cos(c(a.latitude))*Math.cos(c(b.latitude))*Math.sin(f/2)*Math.sin(f/2),h=2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)),i=d*h;return i}var e=a.get("pos");if(console.log(e),console.log(b),!(e&&b&&e.latitude&&e.longitude&&b.latitude&&b.longitude))return"未知距离";var f=d(e,b);return.5>f?"500米":1>f?"1公里":f.toFixed(0)+"公里"}}]),angular.module("mmbaoApp").filter("delivery",function(){return function(a){return a&&50>=a?a+"公里":1001===a?"市区":1002===a?"二环内":1003===a?"三环内":1004===a?"四环内":1005===a?"五环内":1006===a?"六环内":1007===a?"七环内":"未设定"}}),angular.module("mmbaoApp").controller("MainCtrl",["$scope","$location","messages","dialog",function(a,b,c,d){var e=!1;a.login=function(){if(!e){e=!0;var a=new FormData($("form")[0]);c.user.login(a,function(){e=!1,d.toast("登录成功！"),b.path("user/home")})}},a.toRegister=function(){b.path("user/register")},b.path("grocery")}]),angular.module("mmbaoApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("mmbaoApp").controller("UserCtrl",["$scope","$route","$timeout","url","$location","messages","register","api","modal","storage","user","images",function(a,b,c,d,e,f,g,h,i,j,k,l){a.isEditing=!1,a.logined=!1,a.retrievePhone=!0,a.url=d;var m="user";switch(a.$on("$includeContentLoaded",function(){a.module=m}),b.current.$$route.originalPath){case"/user/login":break;case"/user/logout":case"/user/password/retrieve":case"/user/register":case"/user/phone/register":case"/user/email/register":case"/registration/success":break;case"/user/subscribe":case"/user/subscribe/:page":k.profile(function(){console.log("profile"),$(".progress-bar").hide();var c=b.current.params.page;c||(c=1),k.subscribed({page:c},function(b){a.groceries=b.data.results})});break;case"/user/profile":k.profile(function(b){console.log("profile"),$(".progress-bar").hide(),a.user=b,b.extra.logo&&(a.logo=b.extra.logo.url)}),a.edit=function(){a.isEditing=!0,$("input[disabled]").removeAttr("disabled"),$("textarea[disabled]").removeAttr("disabled")},a.update=function(){var b=new FormData($("form")[0]);k.update(b,function(){a.isEditing=!1,i.alert("更新成功！",function(){e.path("user/home")})})};break;default:k.profile(function(b){console.log("profile"),$(".progress-bar").hide(),a.logined=!0,a.user=b,b.extra.logo&&(a.logo=b.extra.logo.url)})}a.login=function(){var a=new FormData($("form")[0]);i.startProgress("正在登录..."),k.login(a,function(){i.stopProgress(function(){e.path(localStorage.getItem("referrer")?localStorage.getItem("referrer"):"user/home")})})},a.logout=function(){k.logout()},a.register=function(){g.username()},a.toRegister=function(){e.path("user/phone/register")},a.toLogin=function(){e.path("user/login")},a.goAbout=function(){e.path("about")},a.goProfile=function(){e.path("user/profile")},a.goFeedback=function(){e.path("user/feedback")},a.feedback=function(){var a=new FormData($("form")[0]);console.log(a),i.startProgress("正在发送反馈信息..."),k.feedback(a,function(){i.stopProgress(function(){i.alert("反馈成功！",function(){e.path("user/home")})})})},a.fileChanged=function(){l.preview($("input[type=file][name=image]")[0].files,function(a){$("img[name=image-logo]").attr("src",a)})},a.saveProfile=function(){var a=new FormData($("form")[0]);console.log(a),i.startProgress("正在保存用户信息..."),k.update(a,function(){i.stopProgress(),c(function(){i.alert("更新成功！",function(){e.path("user/home")})},1e3)})},a.goAddresses=function(){e.path("address/list")},a.goOrders=function(){e.path("order/list")},a.goSubscribed=function(){e.path("user/subscribe")},a.goReceiver=function(){e.path("receivers/list")},a.getCaptcha=function(){return a.phone?validator.isMobilePhone(a.phone,"zh-CN")?($(".btn-get-sms-captcha").attr("disabled","disabled"),$(".btn-get-sms-captcha").html("正在发送..."),void f.captcha.phone({phone:a.phone},function(a){switch(a.code){case errors.SUCCESS.code:var b=60;$(".btn-register").removeAttr("disabled"),$(".btn-get-sms-captcha").html(b--+"秒后重新发送");var c=setInterval(function(){return 0>=b?($(".btn-get-sms-captcha").removeAttr("disabled"),$(".btn-get-sms-captcha").html("重新获取验证码"),void clearInterval(c)):void $(".btn-get-sms-captcha").html(b--+"秒后重新发送")},1e3)}})):void i.alert("手机号不正确",function(){}):void i.alert("请输入手机号！",function(){})},a.checked=!1,a.captcha=!1;var n;$(".btn-get-sms-captcha").attr("disabled","disabled"),$(".btn-get-email-captcha").attr("disabled","disabled"),$(".btn-register").attr("disabled","disabled"),$("[name=captchaImage]").keydown(function(){console.log("captcha"),n&&clearTimeout(n),n=setTimeout(function(){var b=$("[name=captchaImage]").val();f.captcha.check({captcha:b},function(b){switch(a.captcha=!0,b.code){case errors.SUCCESS.code:a.checked=!0,console.log("inside enabled"),$(".btn-get-sms-captcha").removeAttr("disabled"),$(".btn-get-email-captcha").removeAttr("disabled");break;default:a.checked=!1}})},1e3)}),a.updateImage=function(){var a=$("#image-captcha > span"),b=d+"captcha/image?t="+new Date;a.html('<img src="'+b+'"/>')},a.phoneRegister=function(){g.phone(a)},$(".btn-get-email-captcha").attr("disabled","disabled"),a.toEmailRegister=function(){e.path("/user/email/register")},a.getEmailCaptcha=function(){return a.email?validator.isEmail(a.email)?($(".btn-get-email-captcha").attr("disabled","disabled"),$(".btn-get-email-captcha").html("正在发送..."),void f.captcha.email({email:a.email},function(a){switch(a.code){case errors.SUCCESS.code:var b=60;$(".btn-register").removeAttr("disabled"),$(".btn-get-email-captcha").html(b--+"秒后重新发送");var c=setInterval(function(){return 0>=b?($(".btn-get-email-captcha").removeAttr("disabled"),$(".btn-get-email-captcha").html("重新获取验证码"),void clearInterval(c)):void $(".btn-get-email-captcha").html(b--+"秒后重新发送")},1e3)}})):void i.alert("电子邮箱地址不正确",function(){}):void i.alert("请输入电子邮箱地址！",function(){})},a.emailRegister=function(){g.email(a)},a.toLogin=function(){e.path("user/login")},a.retrieve=function(b){if(b){if(!a.phone)return void i.alert("请输入手机号！",function(){});if(!validator.isMobilePhone(a.phone,"zh-CN"))return void i.alert("手机格式不正确!",function(){});f.password.retrieve({phone:a.phone},function(a){switch(console.log(a),a.code){case errors.SUCCESS.code:i.alert("密码重置成功!"),c(function(){e.path("user/login")},3e3);break;default:i.alert("密码重置失败!原因:"+a.message)}})}else{if(!a.email)return void i.alert("请输入电子邮箱！",function(){});if(!validator.isEmail(a.email))return void i.alert("电子邮箱格式不正确!",function(){});f.password.retrieve({email:a.email},function(a){switch(console.log(a),a.code){case errors.SUCCESS.code:i.alert("密码重置成功!"),c(function(){e.path("user/login")},1e3);break;default:i.alert("密码重置失败!原因:"+a.message)}})}},a.retrieveSwitch=function(b){a.retrievePhone=b}}]),angular.module("mmbaoApp").controller("StoreCtrl",["$scope","$location","api","dialog","store",function(a,b,c,d,e){a.isEditing=!1,e.profile(function(b){a.store=b.data,$(".progress-bar").hide()}),a.back=function(){b.path("user/home")},a.edit=function(){a.isEditing=!0,$("input[disabled]").removeAttr("disabled"),$("textarea[disabled]").removeAttr("disabled")},a.update=function(){var c=new FormData($("form")[0]);e.update(c,function(){a.isEditing=!1,d.toast("更新成功！"),setTimeout(function(){b.path("user/home")},1e3)})}}]),angular.module("mmbaoApp").controller("ScanCtrl",["$scope","$location","$timeout","dialog","storage","barcode","api","hardware","images","merchandise",function(a,b,c,d,e,f,g,h,i,j){a.barcode=e.get("barcode"),a.back=function(){b.path("user/home")};var k=j.getList($(".progress-bar"),function(b,c){a.merchandises=b.results,a.total=b.total,a.page=b.page,a.lastPage=c});k.list(),a.next=function(){k.next()},a.prev=function(){k.prev()},a.add=function(){b.path("/scan/add/"+a.barcode.id)},a.backBarcode=function(){b.path("/scan/barcode")},a.save=function(){var a=new FormData($("form")[0]);g.success("merchandise/add",a,function(){d.toast("添加成功!"),setTimeout(function(){b.path("scan/barcode")},1e3)})},a.startCapture=function(){console.log("camera"),h.camera.start(function(a,b){$("input[type=file][name=image]").attr("src",b)})},a.fileChanged=function(){a.images=[],i.preview($("input[type=file][name=image]")[0].files,function(b){console.log(b),a.images.push(b),a.$apply()})},a.bind=function(a){var c=e.get("barcode");f.bind(c.id,a.id,function(){console.log(a),b.path("/barcode/list")})}}]),angular.module("mmbaoApp").controller("GroceryCtrl",["$scope","$timeout","$interval","$route","$location","$filter","grocery","merchandise","storage","messages","user","modal","lbs",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){a.loading=!1,a.failedPos=!1,a.positioning=!1,a.searching=!1,a.startsearch=!1}function o(a){var b=i.get("cart");if(b&&b[a]){var c=!1,d=0,e=0;for(var g in b[a].merchandises){c=!0,v.set(g,b[a].merchandises[g].count),d+=b[a].merchandises[g].count-1+1;var h=(b[a].merchandises[g].price||0)-1+1;e+=(b[a].merchandises[g].count-1+1)*h}c&&$(".cart > b").css("visibility","visible"),$(".cart-bar-item > b").html(d),$(".cart-bar-item > h2 > span").html(f("currency")(e))}}function p(a,b,c,d){var e=a.id,f=i.get("cart");f||(f={}),f[e]||(f[e]={name:a,merchandises:{}});var g=v.get(b.id);g?f[e].merchandises[b.id]={count:v.get(b.id),merchandise:b,price:c,images:d}:delete f[e].merchandises[b.id],i.set("cart",f),o(e)}var q="grocery",r=null;a.fetched=!1,a.listed=!1,a.column="default",a.infoList=!0,a.loggined=k.isLogin(),k.profile(function(){},!0),n(),a.$on("$includeContentLoaded",function(){a.module=q});var s=d.current.params.page;switch(s||(s=1),d.current.$$route.originalPath){case"/grocery/recent":a.type="recent";var t=i.get("groceries");a.groceries=t;break;case"/grocery":case"/grocery/list":case"/grocery/list/:page":n(),a.loading=!0,g.list(s,function(b){n(),console.log(b),a.loading=!1,a.data=b,a.groceries=b.results}),a.type="default";break;case"/grocery/comments":break;case"/grocery/nearby":case"/grocery/nearby/:page":n(),a.positioning=!0,a.type="nearby",m.getPos(function(b,c){n(),b?(a.loading=!0,g.nearby(c,s,function(b){console.log(b),a.loading=!1,a.data=b,a.groceries=b.results,a.$$phase||a.$apply()})):a.failedPos=!0,a.$$phase||a.$apply()});break;case"/grocery/favorite":case"/grocery/favorite/:page":a.type="favorite",k.subscribed({page:s},function(b){a.groceries=b.data.results});break;case"/grocery/info/:id":case"/grocery/info/:id/:page":var u=d.current.params.id;b(function(){var a=d.current.params.id;console.log("inside time out"),o(a)},1e3),j.grocery.issubscribed({id:u},function(c){console.log(c),c.code===errors.SUCCESS.code?b(function(){a.fetched=!0,a.subscribed=c.data.subscribed,a.$$phase||a.$apply()},1e3):b(function(){a.fetched=!0,a.subscribed=!1,a.$$phase||a.$apply()},1e3)}),j.category.list({id:u,page:s},function(b){a.categories=b.data.results}),g.info({id:u},function(b){console.log(b),a.grocery=b.data,a.listed=!1,h.list(u,s,function(b){console.log(b),a.merchandises=b.data.results,a.listed=!0,o(u)})})}a.count=0;var v={get:function(a){return $(".count-"+a).html()},set:function(a,b){$(".count-"+a).html(b),b>0&&$(".minus-"+a).removeClass("disabled")},inc:function(a){var b=this.get(a);b++,$(".count-"+a).html(b),$(".minus-"+a).removeClass("disabled")},desc:function(a){var b=this.get(a);b>0&&(b--,0>=b&&$(".minus-"+a).addClass("disabled"),$(".count-"+a).html(b))}};a.minus=function(b,c,d,e){v.desc(b),p(a.grocery,c,d,e)},a.plus=function(b,c,d,e){v.inc(b),p(a.grocery,c,d,e)},a.order=function(){var a=d.current.params.id,b=i.get("cart");if(!b)return void l.alert("请添加商品到购物车!");var c=b[a];return!c||c.total<1?void l.alert("请添加商品到购物车!"):void(k.isLogin()?e.path("order/make/"+a):e.path("user/login"))},a.subscribe=function(b){console.log(b),a.subscribed?g.unsubscribe(b.id,function(b){console.log(b),a.subscribed=!1,a.$$phase||a.$apply()}):g.subscribe(b.id,function(b){console.log(b),a.subscribed=!0,a.$$phase||a.$apply()})},a.getCategory=function(c){var e=d.current.params.id;$("#list-category > a").removeClass("active"),$("#list-category > a").each(function(){var a=$(this).attr("id");a==="category-"+c.id&&$(this).addClass("active")}),a.listed=!1,j.category.merchandise({id:e,page:1,category:c.id},function(c){a.merchandises=c.data.results,a.listed=!0,b(function(){o(e),a.$$phase||a.$apply()},500)})},a.getFullMerchandise=function(){$("#list-category > a").removeClass("active"),$("#list-category > a#category-0").addClass("active"),a.listed=!1,h.list(u,s,function(c){console.log(c),a.merchandises=c.data.results,a.listed=!0,b(function(){o(u)},500)})},a.goShoppingCart=function(){e.path("cart")},a.nearby=function(){s=1,e.path("/grocery/nearby")},a.list=function(){s=1,a.listed=!1,a.loading=!1,e.path("/grocery/list")},a.recent=function(){s=1,e.path("/grocery/recent")},a.favorite=function(){s=1,e.path("/grocery/favorite")},a.selectGrocery=function(a){var b=i.get("groceries");b||(b=[]);for(var c=0;c<b.length;c++){var d=b[c];if(d.id===a.id)return void e.path("grocery/info/"+a.id)}b.push(a),i.set("groceries",b),e.path("grocery/info/"+a.id)},a.search=function(){function d(){var b=f.val();b&&b!==e&&(a.searching=!0,e=b,a.listed=!1,g.search(b,s,function(b){a.searching=!1,console.log(b),a.data=b,a.groceries=b.results}))}if(a.startsearch=!a.startsearch,a.startsearch){var e=null,f=$("#search-input");r=c(d,1e3),b(function(){f.focus()},500)}else $("#search-input").unbind(),$("#search-input").val(""),c.cancel(r),r=null},a.closeSearch=function(){$("#search-input").val("")},a.showProfile=function(){a.column="profile",a.profiled=!0,a.infoList=!1,a.comments=!1},a.showInfo=function(){a.column="default",a.profiled=!1,a.infoList=!0,a.comments=!1},a.showComments=function(){a.column="comments",a.profiled=!1,a.infoList=!1,a.comments=!0}}]),angular.module("mmbaoApp").controller("OrderCtrl",["$scope","$route","$timeout","messages","address","modal","storage","$location",function(a,b,c,d,e,f,g,h){function i(a){console.log("keydown 1");var b=$("#order-"+a.id);$(".cancel",b).removeClass("hidden").show(),$(".delete",b).removeClass("hidden").show(),p=!1}function j(a){console.log("keyup 1");var b=$("#order-"+a.id);$(".cancel",b).hide(),$(".delete",b).hide(),p=!0}var k="order";a.$on("$includeContentLoaded",function(){a.module=k});var l=b.current.params.page;l||(l=1);var m=b.current.params.id;switch(b.current.$$route.originalPath){case"/order/make/:id":e.list({page:l},function(b){a.addresses=b.data.results});break;case"/order/list":break;case"/order/list/:page":}d.order.list({page:l},function(b){a.orders=b.data.results,a.total=b.data.total,a.page=b.data.page});var n=[{name:"今天",value:1},{name:"一周内",value:7},{name:"10天内",value:10},{name:"30天内",value:30},{name:"3个月内",value:90},{name:"6个月内",value:180},{name:"1年内",value:365}];a.days=n;var o=null,p=!0;a.mouseup=function(a){console.log(a),o},a.mousedown=function(a){console.log("keydown"),console.log(a),o||(o=c(function(){p?i(a):j(a),o=null},1e3))},a.order=function(){function b(a,b,c){if(a){var e=g.get("cart"),h={};h.store=a;var i=0,j=0,k=[];if(!e[a])return void f.alert("请选择商品");for(var l in e[a].merchandises){var m=e[a].merchandises[l];i+=(m.count-1+1)*(m.price-1+1),j+=m.count-1+1;var n={id:l,name:m.merchandise.name,brand:m.merchandise.brand,desc:m.merchandise.desc,number:m.count,price:m.price};m.images&&m.images.length&&(n.url=m.images[0].url),k.push(n)}if(!k.length)return c(errors.NOT_FOUND);h.summary=i,h.merchandises=k,h.total=j,h.receiver=b.receiver,h.address=b.address,h.phone=b.phone,h.payment=b.payment,h.delivery=b.delivery,d.order.create({json:JSON.stringify(h)},c)}else c(errors.NOT_FOUND)}console.log("insdie");var c={};return a.address&&a.address.receiver?a.address.address?a.address.phone?validator.isMobilePhone(a.address.phone,"zh-CN")?(c=a.address,void b(m,c,function(){$("form").each(function(){this.reset()});var a=g.get("cart");delete a[m],g.set("cart",a),h.path("order/list")})):void f.alert("手机号格式错误！"):void f.alert("手机号未指定！"):void f.alert("地址未指定！"):void f.alert("用户名未指定！")},$(".select-address").change(function(){console.log("inside change"),a.address=$(".select-address").find(":selected").text()}),a.selectAddress=function(b){console.log("inside change"),a.address=b},a.pay=function(a){a&&a.id&&h.path("order/pay/"+a.id)}}]),angular.module("mmbaoApp").controller("SystemCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("mmbaoApp").controller("AddressCtrl",["$scope","$route","$location","address","storage","modal",function(a,b,c,d,e,f){var g=b.current.params.page;g||(g=1);var h="user";switch(a.$on("$includeContentLoaded",function(){a.module=h}),b.current.$$route.originalPath){case"/address/list":d.list({page:g},function(b){a.addresses=b.data.results});break;case"/address/add":break;case"/address/edit/:id":var i=b.current.params.id;if(i){var j=e.get("address");a.id=j.id,console.log(a.id),a.address=j.address,a.receiver=j.receiver,a.phone=j.phone}else c.path("address/list")}a.add=function(){var a=new FormData($("form")[0]);console.log(a),d.add(a,function(){f.alert("添加成功！",function(){c.path("address/list")})})},a.select=function(a){e.set("address",a),c.path("address/edit/"+a.id)},a.save=function(){var a=new FormData($("form")[0]);console.log(a),d.update(a,function(){f.alert("更新成功！",function(){c.path("address/list")})})},a.remove=function(a){f.confirm("操作不可能撤销，确定要删除吗？",function(){d.remove({id:a},function(){f.alert("删除成功！",function(){c.path("address/list")})})})}}]),angular.module("mmbaoApp").controller("CartCtrl",["$scope","$route","$timeout","$location","storage","messages","user","modal",function(a,b,c,d,e,f,g,h){function i(a){var b=e.get("cart");if(b&&b[a]){var c=!1,d=0,f=0;for(var g in b[a].merchandises){c=!0,u.set(g,b[a].merchandises[g].count),d+=b[a].merchandises[g].count-1+1;var h=(b[a].merchandises[g].price||0)-1+1;f+=(b[a].merchandises[g].count-1+1)*h}}}function j(a,b,c,d){var f=a.id,g=e.get("cart");
g||(g={}),g[f]||(g[f]={name:a,merchandises:{}});var h=u.get(b.id);console.log(h),0>=h?(delete g[f].merchandises[b.id],Object.keys(g[f].merchandises).length<=0&&($(".cart-"+f).remove(),delete g[f])):g[f].merchandises[b.id]={count:u.get(b.id),merchandise:b,price:c,images:d},e.set("cart",g),i(f)}function k(a,b){var c=a.id,d=e.get("cart");d&&d[c]&&(delete d[c].merchandises[b.id],$("mid-"+b.id).hide(),Object.keys(d[c].merchandises).length<=0&&($(".cart-"+c).remove(),delete d[c]),e.set("cart",d),i(c))}var l="cart";a.$on("$includeContentLoaded",function(){a.module=l});var m=e.get("cart"),n=[];for(var o in m){var p=m[o],q=0,r=0;console.log(p);for(var s in p.merchandises){var t=p.merchandises[s];console.log(t),r+=(t.count-1+1)*(t.price-1+1),q+=t.count-1+1}p.count=q,p.summary=r,n.push(p)}a.carts=n,a.order=function(a){var b=e.get("cart");if(!b)return void h.alert("购物车好象是空的？");var c=b[a];return!c||c.total<1?void h.alert("购物车好象是空的？"):void(g.isLogin()?d.path("order/make/"+a):d.path("user/login"))};var u={get:function(a){return $(".count-"+a).html()},set:function(a,b){$(".count-"+a).html(b),b>0&&$(".minus-"+a).removeClass("disabled")},inc:function(a){var b=this.get(a);b++,$(".count-"+a).html(b),$(".minus-"+a).removeClass("disabled")},desc:function(a){var b=this.get(a);b>0&&(b--,0>=b&&(console.log("inside"),$("mid-"+a).hide(),$(".minus-"+a).addClass("disabled")),$(".count-"+a).html(b))}};a.minus=function(a,b,c,d,e){u.desc(b),j(a,c,d,e)},a.plus=function(a,b,c,d,e){u.inc(b),j(a,c,d,e)},a.remove=function(a,b,c,d,e){k(a,c,d,e)}}]),angular.module("mmbaoApp").controller("PayCtrl",["$scope","$route","$location","messages",function(a,b,c,d){var e=b.current.params.id;switch(a.module="order",b.current.$$route.originalPath){case"/order/pay/:id":break;case"/pay/alipay/:id":d.pay.alipay({id:e},function(a){$(".text").html(a)});break;case"/order/list/:page":}a.back=function(){c.path("/order/pay/"+e)},a.alipay=function(){c.path("/pay/alipay/"+e)}}]);