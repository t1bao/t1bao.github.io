"use strict";angular.module("businessApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider","$httpProvider",function(a,b){b.defaults.useXDomain=!0,b.defaults.withCredentials=!0,window.errors=webErrors.errors,a.when("/",{templateUrl:"views/store/profile.html",controller:"StoreCtrl"}).when("/user/login",{templateUrl:"views/user/login.html",controller:"UserCtrl"}).when("/user/register",{templateUrl:"views/user/register.html",controller:"UserCtrl"}).when("/user/profile",{templateUrl:"views/user/profile.html",controller:"UserCtrl"}).when("/password/retrieve",{templateUrl:"views/password/retrieve.html",controller:"UserCtrl"}).when("/merchandise/list/:page",{templateUrl:"views/merchandise/list.html",controller:"MerchandiseCtrl"}).when("/merchandise/:id/list/:page",{templateUrl:"views/merchandise/list.html",controller:"MerchandiseCtrl"}).when("/merchandise/q/:query/:page",{templateUrl:"views/merchandise/query.html",controller:"MerchandiseCtrl"}).when("/merchandise/:id/q/:query/:page",{templateUrl:"views/merchandise/query.html",controller:"MerchandiseCtrl"}).when("/store/location",{templateUrl:"views/location/main.html",controller:"LocationCtrl"}).when("/store/profile",{templateUrl:"views/store/profile.html",controller:"StoreCtrl"}).when("/barcode/list/:page",{templateUrl:"views/barcode/list.html",controller:"BarcodeCtrl"}).when("/order/list/:page",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/:type/list/:page",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/query/:q/:page",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/:type/query/:q/:page",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/no/:q",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/order/no/:q/:page",{templateUrl:"views/order/list.html",controller:"OrderCtrl"}).when("/subscribed/list/:page",{templateUrl:"views/subscribed/list.html",controller:"SubscribedCtrl"}).when("/user/password",{templateUrl:"views/user/password.html",controller:"UserCtrl"}).when("/user/dashboard",{templateUrl:"views/user/dashboard.html",controller:"UserCtrl"}).when("/category/:parent/list/:id",{templateUrl:"views/category/list.html",controller:"CategoryCtrl"})}]),angular.module("businessApp").controller("UserCtrl",["$scope","$location","$route","api","modal",function(a,b,c,d,e){switch(a.register=function(){var a=new FormData($("form")[0]);d.send("user/register",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&(e.alert("注册成功!"),b.path("user/login"))})},a.login=function(){var a=new FormData($("form")[0]);d.send("user/login",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&(e.alert("登录成功!"),b.path("store/profile"))})},a.retrieve=function(){var a=new FormData($("form")[0]);d.send("password/retrieve",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&e.alert("密码重置成功!")})},c.current.$$route.originalPath){case"/user/login":case"/user/logout":case"/user/password/retrieve":case"/user/register":break;default:d.send("user/profile",{},function(b){b.code===errors.SUCCESS.code&&(a.user=b.data)})}a.updatePassword=function(){var a=new FormData($("form.password")[0]);d.send("password/update",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&(e.alert("密码修改成功，请用新密码重新登录！"),d.send("user/logout",{},function(){b.path("user/login")}))})},a.modify=function(){var b=new FormData($("form.modify")[0]);d.send("user/update",b,function(b){console.log(b),b.code===errors.SUCCESS.code&&($("#modify").modal("hide"),e.alert("更新成功!"),d.send("user/profile",{},function(b){b.code===errors.SUCCESS.code&&(a.user=b.data)}))})}}]),angular.module("businessApp").service("api",["url","$http","$location","modal",function(a,b,c,d){function e(b){return a+h+b}function f(a,f,h,i){var j;j=f?f instanceof FormData?b.post(e(a),f,{withCredentials:!0,headers:{"Content-Type":void 0}}):b.post(e(a),f):b.post(e(a)),h=h||g,j.success(function(a){if("code"in a)if("code"in a&&!a.code)i(a);else switch(a.code){case errors.NOT_LOGIN.code:case errors.MERCHANT_NOT_LOGIN.code:case errors.USER_NOT_LOGIN.code:c.path(h);break;default:a.data?i(a):d.alert(a.message)}else;}).error(function(){if("user/profile"===a)c.path(h);else{var b="请求错误，请检测网络。";d.alert(b)}})}var g="user/login",h="grocery/";return{send:function(a,b,c){f(a,b,null,c)},upload:function(a,f,h){b.post(e(a),f,{withCredentials:!0,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(a){if("code"in a)if("code"in a&&!a.code)h(a);else switch(a.code){case errors.USER_NOT_LOGIN.code:c.path(g);break;default:d.alert(a.message)}else;}).error(function(){c.path(g)})},success:function(a,b,c,d){f(a,b,function(a){return d?c(a):void(a.code===errors.SUCCESS.code&&c(a))})}}}]);var url="http://api.t1bao.com/";window.localStorage&&window.localStorage.getItem("url")&&(url=window.localStorage.getItem("url")),angular.module("businessApp").constant("url",url),angular.module("businessApp").service("modal",["$timeout",function(a){return{alert:function(b,c){$("#modal-alert").modal("show"),$(".modal-body",$("#modal-alert")).html(b),$(".ok",$("#modal-alert")).unbind(),$(".ok",$("#modal-alert")).click(function(){$("#modal-alert").modal("hide"),a(function(){c&&c()},1e3)})},confirm:function(b,c,d){$("#modal-confirm").modal("show"),$(".modal-body",$("#modal-confirm")).html(b),$(".ok",$("#modal-confirm")).unbind(),$(".cancel",$("#modal-confirm")).unbind(),$(".ok",$("#modal-confirm")).click(function(){$("#modal-confirm").modal("hide"),a(function(){c&&c()},1e3)}),$(".cancel",$("#modal-confirm")).click(function(){$("#modal-confirm").modal("hide"),a(function(){d&&d()},1e3)})},startProgress:function(a){$("#modal-progress").modal("show"),$(".note",$("#modal-progress")).html(a)},stopProgress:function(){$("#modal-progress").modal("hide")}}}]),angular.module("businessApp").controller("StoreCtrl",["$scope","modal","api","user",function(a,b,c,d){console.log("insdie store controller");var e="profile";a.$on("$includeContentLoaded",function(){$(".datepicker").datetimepicker({datepicker:!1,lang:"ch",format:"H:i"}),a.module=e,c.send("user/profile",null,function(b){b&&"code"in b&&b.code===errors.SUCCESS.code&&(console.log(b),a.user=b.data,d.set(b.data))})}),a.user=d.get(),c.send("store/profile",{},function(b){b.code===errors.SUCCESS.code&&(a.store=b.data)}),a.modify=function(){var d=new FormData($("form.modify")[0]);console.log(d),c.send("store/update",d,function(d){console.log(d),d.code===errors.SUCCESS.code&&($("#modify").modal("hide"),b.alert("更新成功!"),c.send("store/profile",{},function(b){b.code===errors.SUCCESS.code&&(a.store=b.data)}))})},a.disableDelivery=function(){for(var b=["delivery_fee","delivery_limit","delivery_distance"],c=0;c<b.length;c++)a.store[b[c]]=0}}]),angular.module("businessApp").controller("NavCtrl",["$scope","$location","api","user",function(a,b,c,d){c.send("user/profile",null,function(b){b&&"code"in b&&b.code===errors.SUCCESS.code&&(console.log(b),a.user=b.data,d.set(b.data))}),a.exit=function(){c.send("user/logout",null,function(a){a&&"code"in a&&a.code===errors.SUCCESS.code&&b.path("user/login")})}}]),angular.module("businessApp").service("user",function(){var a;return{set:function(b){a=b},get:function(){return a}}}),angular.module("businessApp").controller("MerchandiseCtrl",["$scope","$route","$location","api","modal","storage",function(a,b,c,d,e,f){function g(b){switch(b){case"online":a.onlineString="上线";break;case"offline":a.onlineString="下线";break;default:a.onlineString="全部"}}function h(b,c){var e={page:b};switch(n&&!isNaN(n)&&(e.category=n),c&&(e.order=c),l){case"online":e.online=!0;break;case"offline":e.online=!1}console.log(l),d.send("merchandise/list",e,function(b){b.code===errors.SUCCESS.code&&(a.merchandises=b.data.results,a.total=b.data.total,a.page=b.data.page)})}function i(b,c,e){var f={q:b,page:c};switch(n&&!isNaN(n)&&(f.category=n),e&&(f.order=e),l){case"online":f.online=!0;break;case"offline":f.online=!1}d.send("merchandise/query",f,function(b){console.log(b),b.code===errors.SUCCESS.code&&(a.merchandises=b.data.results,a.total=b.data.total,a.page=b.data.page)})}function j(b,c){"undefined"!==b&&b?(a.q=b,i(b,m,c)):h(m,c)}var k="merchandise";a.page=0,a.total=0,a.base="merchandise",a.onlineString="全部";var l=f.get("online");g(l),console.log(l);var m=parseInt(b.current.params.page),n=parseInt(b.current.params.id),o=b.current.params.query;o=decodeURIComponent(o);var p={page:m},q=[{name:"价格",value:"price"},{name:"销量",value:"sells"},{name:"访问",value:"visits"}];a.orders=q,d.send("category/list",p,function(b){if(b.code===errors.SUCCESS.code){a.categories=b.data.results;for(var c=0;c<a.categories.length;c++)n===a.categories[c].id&&(a.categoryName=a.categories[c].name);console.log(a.categories)}}),a.$on("$includeContentLoaded",function(){a.module=k}),(!m||1>m)&&(m=1),j(o),a.openAdd=function(){$(".add")[0].reset()},a.add=function(){var a=new FormData($("form.add")[0]);d.send("merchandise/add",a,function(a){switch(a.code){case errors.SUCCESS.code:$("#add").hide(),e.alert("添加成功！"),h(m)}})},a.remove=function(a){confirm("确定要删除吗?操作不可恢复!")&&d.send("merchandise/remove",{id:a.merchandise.id},function(a){switch(a.code){case errors.SUCCESS.code:$("#add").hide(),e.alert("添加成功！"),h(m)}})},a.openModify=function(b){var c=b.merchandise;c.sis=b.sis,c.images=b.images,c.price=b.price,a.merchandise=c,$("#mod-category > option").each(function(){var a=parseInt($(this).val()),c=b.category?b.category.id:0;a===c&&($(this).attr("selected",!0),this.selected=!0)})},a.modify=function(){var a=new FormData($("form.modify")[0]);console.log(a),d.send("merchandise/update",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&($("#modify").modal("hide"),e.alert("更新成功!"),h(m))})},a.removeImage=function(a,b){console.log(a),console.log(b),confirm("确定要删除吗?操作不可恢复!")&&d.send("merchandise/image/remove",{mid:a,id:b},function(a){console.log(a),a.code===errors.SUCCESS.code&&h(m)})},a.search=function(){a.q&&"undefined"!==a.q?n&&!isNaN(n)?c.path("/merchandise/"+n+"/q/"+encodeURIComponent(a.q)+"/1"):c.path("/merchandise/q/"+encodeURIComponent(a.q)+"/1"):e.alert("请输入搜索词")},a.online=function(a){d.send("merchandise/online",{id:a.merchandise.id,online:!0},function(a){console.log(a),a.code===errors.SUCCESS.code&&j(o,m)})},a.offline=function(a){d.send("merchandise/online",{id:a.merchandise.id,online:!1},function(a){console.log(a),a.code===errors.SUCCESS.code&&j(o,m)})},a.selectCategory=function(b){b&&b.id?(a.category=b,c.path("merchandise/"+b.id+"/list/"+m)):(a.category=null,c.path("merchandise/list/"+m))},a.back=function(){n?c.path("merchandise/"+n+"/list/1"):c.path("merchandise/list/1")},a.selectOrder=function(b){if(a.order=b,!b)return j(o);switch(b.value){case"sells":case"price":case"visits":j(o,b.value)}},a.selectOnline=function(a){f.set("online",a),console.log(a),l=a,g(a),j(o)}}]),angular.module("businessApp").controller("LocationCtrl",["$scope","modal","api",function(a,b,c){function d(b,c){c.addEventListener("dragend",function(){var d=c.getPosition();b.panTo(d),console.log(d),a.latitude=d.lat,a.longitude=d.lng,a.$apply()})}function e(a,b){var c=new BMap.Point(b.longitude,b.latitude),e=new BMap.Marker(c);return a.addOverlay(e),d(a,e),e.enableDragging(),a.panTo(c),a.setCenter(c),a.setZoom(15),e}function f(){g=new BMap.Map("map");var a=new BMap.Point(116.404,39.915);h=new BMap.Marker(a),g.addOverlay(h),d(g,h),h.enableDragging(),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){var b=a.coords;g.removeOverlay(h),h=e(g,b)},function(){console.log("insdie error")},{enableHighAcuracy:!0,timeout:5e3,maximumAge:3e3}),g.centerAndZoom(a,11),g.addControl(new BMap.NavigationControl),g.addControl(new BMap.ScaleControl),g.addControl(new BMap.MapTypeControl),g.addControl(new BMap.OverviewMapControl),g.setCurrentCity("北京"),g.enableScrollWheelZoom(!0)}var g,h;a.$on("$includeContentLoaded",function(){a.module="location"}),c.send("location/info",{},function(c){if(console.log(c),c.code===errors.SUCCESS.code){var d=c.data;a.latitude=d.latitude,a.longitude=d.longitude,g.removeOverlay(h),h=e(g,d)}else b.alert(c.message,function(){})}),a.save=function(){if(!a.latitude)return void b.alert("经度没有指定!",function(){});if(!a.longitude)return void b.alert("纬度没有指定!",function(){});var d={};d.latitude=a.latitude,d.longitude=a.longitude,d.altitude=1,d.accuracy=80,d.heading=3,d.speed=0,c.send("location/update",d,function(a){console.log(a),a.code===errors.SUCCESS.code?b.alert("位置更新成功！",function(){}):b.alert(a.message,function(){})})},f()}]),angular.module("businessApp").controller("BarcodeCtrl",["$route","$scope","api",function(a,b,c){function d(a){c.send("merchandise/list",{page:a},function(a){a.code===errors.SUCCESS.code&&(b.merchandises=a.data.results,b.total=a.data.total,b.page=a.data.page)})}function e(a){c.send("barcode/list",{page:a},function(a){a.code===errors.SUCCESS.code&&(b.barcodes=a.data.results,b.page=a.data.page,b.total=a.data.total)})}function f(){var a,f=1;b.openBind=function(b){f=1,a=b,console.log(b),d(f)},b.prev=function(){f>1&&f--,d(f)},b.next=function(){f++,d(f)},b.onSelectItem=function(a){b.merchandise=a.merchandise,b.merchandise.sis=a.sis,b.merchandise.images=a.images,console.log(a.merchandise)},b.bind=function(){console.log(a),c.send("barcode/bind",{barcode:a.barcode.id,merchandise:b.merchandise.id},function(a){switch(a.code){case errors.SUCCESS.code:$("#bindMerchandise").hide(),e(h)}})},b.unbind=function(a){c.send("barcode/unbind",{barcode:a.barcode.id},function(a){switch(a.code){case errors.SUCCESS.code:$("#bindMerchandise").hide(),e(h)}})}}var g="barcode";b.page=0,b.total=0,b.base="barcode";var h=parseInt(a.current.params.page);b.$on("$includeContentLoaded",function(){b.module=g,c.send("user/profile",null,function(a){a&&"code"in a&&a.code===errors.SUCCESS.code&&(console.log(a),b.user=a.data)})}),e(h),b.openQuery=function(){b.queried=!1},b.query=function(){console.log("query"),b.queried=!1;var a=new FormData($("form.query")[0]);c.send("barcode/query",a,function(a){switch(console.log(a),b.queried=!0,a.code){case errors.NOT_FOUND.code:console.log("not found"),b.merchandise=a.data.merchandise;break;case errors.SUCCESS.code:console.log(a.data.merchandise),b.found=!0,b.merchandise=a.data.merchandise}e(h)})},b.remove=function(a){confirm("确定要删除吗?操作不可恢复!")&&c.send("barcode/remove",{id:a.id},function(b){switch(console.log(b),b.code){case errors.SUCCESS.code:$("barcode-remove-"+a.id).remove(),e(h)}})},f()}]),angular.module("businessApp").filter("currency",function(){return function(a){return a=parseFloat(a).toFixed(2),isNaN(a)&&(a=0),parseFloat(a).toFixed(2)}}),angular.module("businessApp").controller("OrderCtrl",["$scope","$route","$location","api",function(a,b,c,d){function e(b,c){var e={page:b};i&&(e[i]=!0),c&&!isNaN(c)&&(e.days=c),console.log(e),d.send("order/list",e,function(b){switch(console.log(b),b.code){case errors.SUCCESS.code:console.log(b),a.orders=b.data.results,a.page=b.data.page,a.total=b.data.total,a.count=b.data.count,a.base="order"}})}function f(b,c){d.send("order/query",{no:b,page:c},function(b){switch(b.code){case errors.SUCCESS.code:console.log(b),a.orders=b.data.results,a.page=b.data.page,a.total=b.data.total,a.count=b.data.count,a.base="order"}})}function g(b,c){var e={page:c,q:b};i&&(e[i]=!0),d.send("order/query",e,function(b){switch(console.log(b),b.code){case errors.SUCCESS.code:console.log(b),a.orders=b.data.results,a.page=b.data.page,a.total=b.data.total,a.count=b.data.count,a.base="order"}})}var h=parseInt(b.current.params.page);(!h||1>h)&&(h=1);var i=b.current.params.type,j=b.current.params.q,k={page:h};i&&(k[i]=!0);var l=[{name:"已完成",value:"is_finished"},{name:"已支付",value:"is_payed"},{name:"已取消",value:"is_cancelled"}];a.types=l;for(var m=[{name:"今天",value:1},{name:"一星期内",value:7},{name:"10天内",value:10},{name:"30天内",value:30},{name:"3个月内",value:90},{name:"6个月内",value:180},{name:"1年内",value:365}],n=0;n<l.length;n++)l[n].value===i&&(a.typeName=l[n].name);switch(a.days=m,a.$on("$includeContentLoaded",function(){a.module="order"}),b.current.$$route.originalPath){case"/order/list/:page":case"/order/:type/list/:page":e(h);break;case"/order/no/:q":case"/order/no/:q/:page":console.log("inside no"),f(j,h);break;case"/order/query/:q/:page":case"/order/:type/query/:q/:page":g(j,h)}a.cancel=function(a){d.send("order/cancel",{id:a.id},function(a){switch(console.log(a),a.code){case errors.SUCCESS.code:console.log(a),e(h)}})},a.query=function(){a.q&&(i?c.path("order/"+i+"/query/"+a.q+"/"+h):c.path("order/query/"+a.q+"/"+h))},a.no=function(){a.q&&c.path("order/no/"+a.q+"/"+h)},a.back=function(){c.path("order/list/"+h)},a.selectType=function(a){a?c.path("order/"+a.value+"/list/1"):c.path("order/list/1")},a.selectDays=function(b){b?(a.dayName=b.name,e(h,b.value)):(a.dayName=null,e(h))}}]),angular.module("businessApp").controller("SubscribedCtrl",["$scope","$route","api",function(a,b,c){a.$on("$includeContentLoaded",function(){a.module="subscribed",a.total=0,a.page=0,c.send("user/profile",null,function(b){b&&"code"in b&&b.code===errors.SUCCESS.code&&(console.log(b),a.user=b.data)})});var d=parseInt(b.current.params.page);(!d||1>d)&&(d=1),c.send("subscribed/list",{page:d},function(b){switch(console.log(b),b.code){case errors.SUCCESS.code:console.log(b),a.subscibed=b.data.results,a.total=b.data.total,a.count=b.data.count,a.page=b.data.page}})}]),angular.module("businessApp").controller("CategoryCtrl",["$scope","$route","api",function(a,b,c){function d(b){c.send("category/list",{page:b},function(b){b.code===errors.SUCCESS.code&&(a.categories=b.data.results,a.total=b.data.total,a.page=b.data.page)})}var e=parseInt(b.current.params.page);(!e||1>e)&&(e=1),a.$on("$includeContentLoaded",function(){a.module="category",c.send("user/profile",null,function(b){b&&"code"in b&&b.code===errors.SUCCESS.code&&(console.log(b),a.user=b.data)})}),d(e),a.openAdd=function(){$(".subcategory.add")[0].reset()},a.add=function(){var a=new FormData($("form.add")[0]);console.log(a),c.send("category/create",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&(d(e),$("#add").hide())})},a.openModify=function(b){a.category=b},a.remove=function(a){confirm("操作不可恢复，你确定要删除吗？")&&c.send("category/remove",{id:a.id},function(a){console.log(a),a.code===errors.SUCCESS.code&&d(e)})},a.update=function(){var a=new FormData($("form.update")[0]);console.log(a),c.send("category/update",a,function(a){console.log(a),a.code===errors.SUCCESS.code&&(d(e),$("#modify").hide())})},a.online=function(a){c.send("category/online",{id:a.id,online:!0},function(b){console.log(b),b.code===errors.SUCCESS.code&&(a.online=!0)})},a.offline=function(a){c.send("category/online",{id:a.id,online:!1},function(b){console.log(b),b.code===errors.SUCCESS.code&&(a.online=!1)})}}]),angular.module("businessApp").filter("date",function(){return function(a){var b=new Date(a);return moment(b).format("YYYY-MM-DD hh:mm:ss")}}),angular.module("businessApp").service("storage",function(){var a={};return{set:function(b,c){a[b]=c,window.localStorage&&window.localStorage.setItem(b,JSON.stringify(c))},get:function(b){if(a[b])return a[b];if(window.localStorage){var c=window.localStorage.getItem(b);return c=JSON.parse(c)}}}});